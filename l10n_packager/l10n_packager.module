<?php

/**
 * @file
 *   Localization packager module for localization server.
 */

/**
 * Release packager status: do not repackage anymore.
 */

const L10N_PACKAGER_DISABLED = 0;

/**
 * Release packager status: keep repackaging.
 */
const L10N_PACKAGER_ACTIVE = 1;

/**
 * Release packager status: error.
 */
const L10N_PACKAGER_ERROR = 2;

/**
 * Default path structure for generated files
 */
const L10N_PACKAGER_FILEPATH = '%core/%project/%project-%release.%language.po';

/**
 * Packager API version.
 */
const L10N_PACKAGER_API_VERSION = '1.1';

/**
 * Implements hook_menu().
 */
function l10n_packager_menu() {

  // Administration tools.
  $items['admin/l10n_server/packager'] = array(
    'title' => 'Packaging tools',
    'description' => 'Select project, releases and languages to repackage.',
    'page callback' => 'l10n_packager_admin_repackage_page',
    'file' => 'l10n_packager.admin.inc',
    'access arguments' => array('administer localization server'),
  );
  $items['admin/l10n_server/packager/package'] = array(
    'title' => 'Package',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
  );
  $items['admin/l10n_server/packager/configure'] = array(
    'title' => 'Configure',
    'description' => 'Configure automatic packaging for translations.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('l10n_packager_settings_form'),
    'file' => 'l10n_packager.admin.inc',
    'access arguments' => array('administer localization server'),
    'type' => MENU_LOCAL_TASK,
    'weight' => 10,
  );
  return $items;
}

/**
 * Implements hook_cron().
 */
function l10n_packager_cron() {
  if (\Drupal::config('l10n_packager.settings')->get('cron')) {
    /** @var \Drupal\l10n_packager\PackagerManager $packagerManager */
    $packagerManager = \Drupal::service('l10n_packager.manager');
    $packagerManager->checkUpdates();
  }
}

// == Language list export =====================================================

/**
 * Implements hook_form_alter().
 */
function l10n_packager_form_alter(&$form, $form_state, $form_id) {
  $languages_forms = array(
    'locale_languages_configure_form',
    'locale_languages_edit_form',
    'locale_languages_delete_form',
    'locale_languages_predefined_form',
    'locale_languages_custom_form',
  );
  if (in_array($form_id, $languages_forms)) {
    $form['#submit'][] = 'l10n_packager_export_metafile';
  }
}


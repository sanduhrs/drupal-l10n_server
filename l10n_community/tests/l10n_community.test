<?php
// $Id$

/**
 * @file
 *   Tests to ensure that the localization server works as intended.
 */

class L10nServerTestCase extends DrupalWebTestCase {
  
  public static function getInfo() {
    return array(
      'name' => t('Localization server'),
      'description' => t('Ensure that the localization server functions properly.'),
      'group' => t('Localization server'),
    );
  }

  public function setUp() {
    // Set up required modules for l10n_community.
    parent::setUp('locale', 'potx', 'l10n_community', 'l10n_localpacks');

    // Prepare users on different permission levels.
    $this->u_anon = $this->drupalCreateUser();
    $this->u_auth = $this->drupalCreateUser(array('access localization community'));
    $this->u_admin = $this->drupalCreateUser(array('administer languages', 'administer localization community', 'administer localization community for local packages'));

    // Set up temporary directory for our work. Because this is inside the
    // simpletest controlled file path, it will be cleaned up later.
    $this->temp_path = file_directory_path() .'/l10n_community_test';
    if (!is_dir($this->temp_path)) {
      mkdir($this->temp_path);
    }
    else {
      simpletest_clean_temporary_directory(file_directory_path() .'/l10n_community_test');
    }
    
    // Set local package directory, so we can work with this.
    $this->drupalLogin($this->u_admin);
    $edit['l10n_localpacks_directory'] = $this->temp_path;
    $this->drupalPost('admin/l10n_server/l10n_localpacks', $edit, t('Save configuration'));
    $this->assertText(t('The configuration options have been saved.'), t('Local package directory set.'));
  }
  
  /**
   * Test accessibility of welcome screen.
   */
  public function testWelcome() {
    // Non-priviledged users should not have access to the welcome screen. 
    $this->drupalLogin($this->u_anon);
    $this->drupalGet('translate');
    $this->assertNoText(t('Quick stats'), t('Welcome screen not visible to non-priviledged user.'));
    $this->drupalGet('user/logout');
    
    // Priviledged users should have access to the welcome screen. 
    $this->drupalLogin($this->u_auth);
    $this->drupalGet('translate');
    $this->assertText(t('Quick stats'), t('Welcome screen visible to priviledged user.'));
    $this->drupalGet('user/logout');
  }

  /**
   * Test basic functionality on languages screen.
   */
  public function testLanguagesProjects() {
    // Non-priviledged users should not have access to the welcome screen. 
    $this->drupalLogin($this->u_auth);
    $this->drupalGet('translate/languages');
    $this->assertText(t('No languages to list.'), t('Language list empty on start.'));
    $this->drupalGet('user/logout');
    
    // Add a language to the environment.
    $this->addLanguage();
    
    // Check that l10n_server now gives us a different error.
    $this->drupalLogin($this->u_auth);
    $this->drupalGet('translate/languages');
    $this->assertText(t('No strings to translate.'), t('Language now recognized, but still no strings to translate.'));
    $this->drupalGet('user/logout');
  
    // Add and parse a project in the environment.
    $this->addProject();

    $this->drupalLogin($this->u_auth);
    $this->drupalGet('translate/languages');
    $this->assertText('Hungarian', t('With project in place, language list is visible.'));

    $this->drupalGet('translate/projects');
    $this->assertText($this->project_name, t('With project in place, project list is shown.'));

    $this->drupalGet('translate/projects/'. $this->project_name);
    $this->assertText('Hungarian', t('Language shows up on project page.'));
    $this->assertText(t('1 release known'), t('One release known on project.'));
    $this->assertText(t('1 release parsed'), t('One release parsed on project.'));
  }
  
  /**
   * Helper function to add a language. Used by other tests.
   */
  private function addLanguage() {
    // Add a language.
    $this->drupalLogin($this->u_admin);
    $edit = array('langcode' => 'hu');
    $this->drupalPost('admin/settings/language/add', $edit, t('Add language'));
    $this->assertText('Hungarian', t('Hungarian language added to system.'));
    $this->assertText(t('Hungarian'), t('Hungarian language added to system.'));
    $this->drupalGet('user/logout');
  }
  
  private function addProject() {
    include_once 'Archive/Tar.php';
    // Follow the required file name format, so the package connector finds it.
    $this->package_file = tempnam($this->temp_path, 'l10n_test') .'-6.x-3.5.tar.gz';
    // Store project name as start of filename.
    list($this->project_name) = explode('-', basename($this->package_file));
    $tar = new Archive_Tar($this->package_file, 'gz');
    // Add the file as a string, so we can control its placement/name.
    $tar->addString('l10n_test.module', file_get_contents(drupal_get_path('module', 'l10n_community') .'/tests/l10n_test.module'));
    $this->assertTrue(file_exists($this->package_file), t('Test package created.'));
    $this->assertTrue(filesize($this->package_file) > 0, t('Test package contains data.'));
    $this->pass('Temporary file at '. $this->package_file);
    $this->pass('List of package: '. var_export($tar->listContent(), TRUE));

    // Login as admin and get this package parsed.
    $this->drupalLogin($this->u_admin);
    $this->drupalGet('admin/l10n_server/l10n_localpacks/scan');
    $this->assertRaw(t('Contents of %filename have been scanned.', array('%filename' => $this->package_file)), t('Contents of project tarball parsed.'));
    $this->drupalGet('user/logout');
   }
  
  /**
   * Debug functionality until simpletest built-in debugging is backported.
   */
  private function outputScreenContents($description, $basename) {
    // This is a hack to get a directory that won't be cleaned up by simpletest
    $file_dir = file_directory_path() .'/../simpletest_output_pages';
    if (!is_dir($file_dir)) {
      mkdir($file_dir, 0777, TRUE);
    }
    $output_path = "$file_dir/$basename.". $this->randomName(10) .'.html';
    $rv = file_put_contents($output_path, $this->drupalGetContent());
    $this->pass("$description: ". l('Contents of result page', $output_path));
  }

}

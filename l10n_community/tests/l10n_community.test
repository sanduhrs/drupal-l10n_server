<?php
// $Id$

/**
 * @file
 *   Tests to ensure that the localization server works as intended.
 */

class L10nServerTestCase extends DrupalWebTestCase {
  
  public static function getInfo() {
    return array(
      'name' => t('Localization server'),
      'description' => t('Ensure that the localization server functions properly.'),
      'group' => t('Localization server'),
    );
  }

  public function setUp() {
    // Set up required modules for l10n_community.
    parent::setUp('locale', 'potx', 'l10n_community', 'l10n_localpacks');

    // Prepare users on different permission levels.
    $this->u_anon = $this->drupalCreateUser();
    $this->u_auth = $this->drupalCreateUser(array('access localization community'));
    $this->u_admin = $this->drupalCreateUser(array('administer languages', 'administer localization community', 'administer localization community for local packages'));

    // Set up temporary directory for our work. Because this is inside the
    // simpletest controlled file path, it will be cleaned up later.
    $this->temp_path = file_directory_path() .'/l10n_community_test';
    if (!is_dir($this->temp_path)) {
      mkdir($this->temp_path);
    }
    else {
      simpletest_clean_temporary_directory(file_directory_path() .'/l10n_community_test');
    }
    
    // Set local package directory, so we can work with this.
    $this->drupalLogin($this->u_admin);
    $edit['l10n_localpacks_directory'] = $this->temp_path;
    $this->drupalPost('admin/l10n_server/l10n_localpacks', $edit, t('Save configuration'));
    $this->assertText(t('The configuration options have been saved.'), t('Local package directory set.'));
    
    $this->package_files = $this->project_names = array();
  }
  
  /**
   * Test accessibility of welcome screen.
   */
  public function testWelcome() {
    // Non-priviledged users should not have access to the welcome screen. 
    $this->drupalLogin($this->u_anon);
    $this->drupalGet('translate');
    $this->assertNoText(t('Quick stats'), t('Welcome screen not visible to non-priviledged user.'));
    $this->drupalGet('user/logout');
    
    // Priviledged users should have access to the welcome screen. 
    $this->drupalLogin($this->u_auth);
    $this->drupalGet('translate');
    $this->assertText(t('Quick stats'), t('Welcome screen visible to priviledged user.'));
    $this->drupalGet('user/logout');
  }

  /**
   * Test basic functionality on languages screen.
   */
  public function testLanguagesProjects() {
    // Non-priviledged users should not have access to the welcome screen. 
    $this->drupalLogin($this->u_auth);
    $this->drupalGet('translate/languages');
    $this->assertText(t('No languages to list.'), t('Language list empty on start.'));
    $this->drupalGet('user/logout');
    
    // Add a language to the environment.
    $this->addLanguage();
    
    // Check that l10n_server now gives us a different error.
    $this->drupalLogin($this->u_auth);
    $this->drupalGet('translate/languages');
    $this->assertText(t('No strings to translate.'), t('Language now recognized, but still no strings to translate.'));
    $this->drupalGet('user/logout');
  
    // Add and parse a project in the environment.
    $this->addProject(5);
    $this->addProject(6);
    $this->addProject(7);

    $this->drupalLogin($this->u_auth);
    $this->drupalGet('translate/languages');
    $this->assertText('Hungarian', t('With projects in place, language list is visible.'));

    $this->drupalGet('translate/projects');
    foreach ($this->project_names as $api => $name) {
      $this->assertText($name, t('@project name is shown on project page.', array('@project' => $name)));
    }

    foreach ($this->project_names as $api => $name) {
      $this->drupalGet('translate/projects/'. $name);
      $this->assertText('Hungarian', t('Language shows up on project page.'));
      $this->assertText(t('1 release known'), t('One release known on project.'));
      $this->assertText(t('1 release parsed'), t('One release parsed on project.'));
      //$this->outputScreenContents();
    
      $this->drupalGet('translate/languages/hu/view', array('query' => 'limit=50&project='. $name));
      //$this->outputScreenContents();
    }
  }
  
  /**
   * Helper function to add a language. Used by other tests.
   */
  private function addLanguage() {
    // Add a language.
    $this->drupalLogin($this->u_admin);
    $edit = array('langcode' => 'hu');
    $this->drupalPost('admin/settings/language/add', $edit, t('Add language'));
    $this->assertText('Hungarian', t('Hungarian language added to system.'));
    $this->assertText(t('Hungarian'), t('Hungarian language added to system.'));
    $this->drupalGet('user/logout');
  }
  
  private function addProject($api_version = 6) {
    include_once 'Archive/Tar.php';
    // Follow the required file name format, so the package connector finds it.
    $this->package_files[$api_version] = ($package_file = tempnam($this->temp_path, 'l10n_test') .'-'. $api_version . '.x-3.5.tar.gz');
    // Store project name as start of filename.
    list($project_name) = explode('-', basename($package_file));
    $this->project_names[$api_version] = $project_name;
    $tar = new Archive_Tar($package_file, 'gz');
    
    // Add the files as strings, so we can control their placement/name.
    $tar->addString('potx_test_'. $api_version .'.module', file_get_contents(drupal_get_path('module', 'potx') .'/tests/potx_test_'. $api_version .'.module'));
    // Add .info file tailored to the module filename (although this is not
    // important for potx, just to be clear about identification).
    $tar->addString('potx_test_'. $api_version .'.info', file_get_contents(drupal_get_path('module', 'potx') .'/tests/potx_test_6.info'));
    // Add .js file regardless of api version. Although Drupal 5 parsing should
    // not pick this up, this packaging allows us to test for that exactly.
    $tar->addString('potx_test_'. $api_version .'.js', file_get_contents(drupal_get_path('module', 'potx') .'/tests/potx_test.js'));
    
    $this->assertTrue(file_exists($package_file), t('Test package created.'));
    $this->assertTrue(filesize($package_file) > 0, t('Test package contains data.'));
    $this->pass('Temporary file at '. $package_file);
    $this->pass('List of package files: '. var_export($tar->listContent(), TRUE));

    // Login as admin and get this package parsed.
    $this->drupalLogin($this->u_admin);
    $this->drupalGet('admin/l10n_server/l10n_localpacks/scan');
    $this->assertRaw(t('Contents of %filename have been scanned.', array('%filename' => $package_file)), t('Contents of project tarball parsed.'));
    $this->drupalGet('user/logout');
   }
  
  /**
   * Debug functionality until simpletest built-in debugging is backported.
   */
  private function outputScreenContents($description = 'output', $basename = 'output') {
    // This is a hack to get a directory that won't be cleaned up by simpletest
    $file_dir = file_directory_path() .'/../simpletest_output_pages';
    if (!is_dir($file_dir)) {
      mkdir($file_dir, 0777, TRUE);
    }
    $output_path = "$file_dir/$basename.". $this->randomName(10) .'.html';
    $rv = file_put_contents($output_path, $this->drupalGetContent());
    $this->pass("$description: ". l('Contents of result page', $output_path));
  }

}
